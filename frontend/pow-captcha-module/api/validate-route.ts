import { NextResponse } from "next/server";
import * as snarkjs from "snarkjs";

export const runtime = "nodejs";

// Inline the verification key so there is no fs dependency at runtime.
// Must match the verification key produced by the ZK pipeline (same circuit + same pot12_final.ptau + same zkey contribution).
const VERIFICATION_KEY = {
  protocol: "groth16",
  curve: "bn128",
  nPublic: 1,
  vk_alpha_1: [
    "14844861651558761639140777754936244997877090757547145734876058994818817818836",
    "9945931977772644392356050716695012117620936982047600206567286419142717889191",
    "1",
  ],
  vk_beta_2: [
    [
      "5173087684915955517023014379262956729036840823305491142510535111785167991111",
      "4530589395026251553641310644393927425933000569910640687376839542026170165598",
    ],
    [
      "11387618935476796698577145908591944529287616386850766712760571279263600211558",
      "9711188009569956857036900982703231352133229526873306425054923889057612687210",
    ],
    ["1", "0"],
  ],
  vk_gamma_2: [
    [
      "10857046999023057135944570762232829481370756359578518086990519993285655852781",
      "11559732032986387107991004021392285783925812861821192530917403151452391805634",
    ],
    [
      "8495653923123431417604973247489272438418190587263600148770280649306958101930",
      "4082367875863433681332203403145435568316851327593401208105741076214120093531",
    ],
    ["1", "0"],
  ],
  vk_delta_2: [
    [
      "16871762366314855718054637733086093152793709888152350332330313539170588518934",
      "3470988139928480399912138396199400086077442429434472826521240147068033552303",
    ],
    [
      "9433237989847374843652180631480636787166663091297396532882929301014784493669",
      "687346362910790782265367598390733487260169513993144199620614052982372392937",
    ],
    ["1", "0"],
  ],
  vk_alphabeta_12: [
    [
      [
        "3055802603747652532709293345233178134715752433226703458096133031727030724730",
        "12158852941786450278157110898104574751712021936062326529468191381450882333618",
      ],
      [
        "6029575931975831319001909676712754864355905755711631984700145825273854912208",
        "13337830857646546698445620416425261623823152320627798212116131247513774864179",
      ],
      [
        "11322349200803162830414827821810826898967129718131139932147043471939379246075",
        "18673668130196439089257422718235362401729800063800335239958883004148632860768",
      ],
    ],
    [
      [
        "9662971633348251503669437187767032571066148804184399603843768357956406496330",
        "869585604409972410194271964005680266981013341908809920416754822525635865132",
      ],
      [
        "14153146695984792771157496588367074834213881317544137102601434427435609068606",
        "11313205880616293204811707303918644879862555449241500461452366852350945071063",
      ],
      [
        "10197678947120288384536078560900598842207855018748726977083712341285526652152",
        "3494684046653007251975706078787816346088872361800478205482699653158574728768",
      ],
    ],
  ],
  IC: [
    [
      "12580738360082872957704402426207424167800339718060455675829666237801971606242",
      "6881524159316020720336638435516234983836780207289707534244376472391480953968",
      "1",
    ],
    [
      "14427320362781974627102151362340949851053301565567952349485978200468587267642",
      "945799347135697701217371628518919194911454440584849575084366378449585876334",
      "1",
    ],
  ],
};

export async function POST(req: Request) {
  try {
    const { proof, publicSignals } = await req.json();

    if (!proof || !publicSignals) {
      return NextResponse.json(
        { verified: false, error: "Missing proof or publicSignals" },
        { status: 400 },
      );
    }

    const isValid = await snarkjs.groth16.verify(
      VERIFICATION_KEY,
      publicSignals,
      proof,
    );

    if (!isValid) {
      return NextResponse.json({ verified: false, error: "Proof verification failed" });
    }

    if (publicSignals[0] !== "1") {
      return NextResponse.json({
        verified: false,
        error: "Circuit output isHuman !== 1",
      });
    }

    return NextResponse.json({ verified: true });
  } catch (err: unknown) {
    const msg = err instanceof Error ? err.message : String(err);
    return NextResponse.json(
      { verified: false, error: msg },
      { status: 500 },
    );
  }
}
