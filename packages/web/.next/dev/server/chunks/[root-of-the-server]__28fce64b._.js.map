{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/nisch/Desktop/Velocity-1/packages/web/app/api/zk-proof/route.ts"],"sourcesContent":["import { spawnSync } from \"child_process\";\nimport path from \"path\";\n\nimport { NextResponse } from \"next/server\";\n\nexport const runtime = \"nodejs\";\n\ntype PipelineResult = {\n  success: boolean;\n  message: string;\n  verified?: boolean;\n  proofPath?: string;\n  publicSignalsPath?: string;\n};\n\nfunction splitLines(text: string): string[] {\n  return text\n    .split(/\\r?\\n/)\n    .map((line) => line.trimEnd())\n    .filter((line) => line.length > 0);\n}\n\nexport async function POST(req: Request) {\n  try {\n    const body = await req.json();\n    const score = Number(body?.score);\n\n    if (!Number.isFinite(score)) {\n      return NextResponse.json({ ok: false, error: \"Invalid score payload.\" }, { status: 400 });\n    }\n\n    const generatorDir = path.resolve(process.cwd(), \"../../backend/zkProofGeneratorTest\");\n    const runnerPath = path.join(generatorDir, \"runPipelineFromScore.js\");\n    const proc = spawnSync(\"node\", [runnerPath, String(Math.round(score))], {\n      cwd: generatorDir,\n      encoding: \"utf-8\",\n      maxBuffer: 1024 * 1024 * 20,\n    });\n    const stdout = (proc.stdout ?? \"\").trim();\n    const stderr = (proc.stderr ?? \"\").trim();\n    const stdoutLines = splitLines(stdout);\n    const stderrLines = splitLines(stderr);\n    const lastStdoutLine = stdoutLines.at(-1);\n    const pipelineLogs = stdoutLines.slice(0, -1);\n\n    if (!lastStdoutLine) {\n      return NextResponse.json(\n        { ok: false, error: stderr || \"Pipeline produced no output.\", pipelineLogs, stderrLogs: stderrLines },\n        { status: 500 },\n      );\n    }\n\n    let result: PipelineResult;\n    try {\n      result = JSON.parse(lastStdoutLine) as PipelineResult;\n    } catch {\n      return NextResponse.json(\n        {\n          ok: false,\n          error: \"Could not parse pipeline output.\",\n          details: stderr || stdout.slice(-1200),\n          pipelineLogs,\n          stderrLogs: stderrLines,\n        },\n        { status: 500 },\n      );\n    }\n\n    if (proc.status !== 0 || !result.success) {\n      return NextResponse.json(\n        {\n          ok: false,\n          error: result.message,\n          verified: result.verified ?? false,\n          pipelineLogs,\n          stderrLogs: stderrLines,\n        },\n        { status: 400 },\n      );\n    }\n\n    return NextResponse.json({\n      ok: true,\n      message: result.message,\n      verified: result.verified ?? false,\n      proofPath: result.proofPath,\n      publicSignalsPath: result.publicSignalsPath,\n      pipelineLogs,\n      stderrLogs: stderrLines,\n    });\n  } catch (e: unknown) {\n    const message = e instanceof Error ? e.message : String(e);\n    return NextResponse.json({ ok: false, error: message }, { status: 500 });\n  }\n}\n"],"names":[],"mappings":";;;;;;AAAA;AACA;AAEA;;;;AAEO,MAAM,UAAU;AAUvB,SAAS,WAAW,IAAY;IAC9B,OAAO,KACJ,KAAK,CAAC,SACN,GAAG,CAAC,CAAC,OAAS,KAAK,OAAO,IAC1B,MAAM,CAAC,CAAC,OAAS,KAAK,MAAM,GAAG;AACpC;AAEO,eAAe,KAAK,GAAY;IACrC,IAAI;QACF,MAAM,OAAO,MAAM,IAAI,IAAI;QAC3B,MAAM,QAAQ,OAAO,MAAM;QAE3B,IAAI,CAAC,OAAO,QAAQ,CAAC,QAAQ;YAC3B,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,IAAI;gBAAO,OAAO;YAAyB,GAAG;gBAAE,QAAQ;YAAI;QACzF;QAEA,MAAM,eAAe,4GAAI,CAAC,OAAO,CAAC,QAAQ,GAAG,IAAI;QACjD,MAAM,aAAa,4GAAI,CAAC,IAAI,CAAC,cAAc;QAC3C,MAAM,OAAO,IAAA,gIAAS,EAAC,QAAQ;YAAC;YAAY,OAAO,KAAK,KAAK,CAAC;SAAQ,EAAE;YACtE,KAAK;YACL,UAAU;YACV,WAAW,OAAO,OAAO;QAC3B;QACA,MAAM,SAAS,CAAC,KAAK,MAAM,IAAI,EAAE,EAAE,IAAI;QACvC,MAAM,SAAS,CAAC,KAAK,MAAM,IAAI,EAAE,EAAE,IAAI;QACvC,MAAM,cAAc,WAAW;QAC/B,MAAM,cAAc,WAAW;QAC/B,MAAM,iBAAiB,YAAY,EAAE,CAAC,CAAC;QACvC,MAAM,eAAe,YAAY,KAAK,CAAC,GAAG,CAAC;QAE3C,IAAI,CAAC,gBAAgB;YACnB,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,IAAI;gBAAO,OAAO,UAAU;gBAAgC;gBAAc,YAAY;YAAY,GACpG;gBAAE,QAAQ;YAAI;QAElB;QAEA,IAAI;QACJ,IAAI;YACF,SAAS,KAAK,KAAK,CAAC;QACtB,EAAE,OAAM;YACN,OAAO,gJAAY,CAAC,IAAI,CACtB;gBACE,IAAI;gBACJ,OAAO;gBACP,SAAS,UAAU,OAAO,KAAK,CAAC,CAAC;gBACjC;gBACA,YAAY;YACd,GACA;gBAAE,QAAQ;YAAI;QAElB;QAEA,IAAI,KAAK,MAAM,KAAK,KAAK,CAAC,OAAO,OAAO,EAAE;YACxC,OAAO,gJAAY,CAAC,IAAI,CACtB;gBACE,IAAI;gBACJ,OAAO,OAAO,OAAO;gBACrB,UAAU,OAAO,QAAQ,IAAI;gBAC7B;gBACA,YAAY;YACd,GACA;gBAAE,QAAQ;YAAI;QAElB;QAEA,OAAO,gJAAY,CAAC,IAAI,CAAC;YACvB,IAAI;YACJ,SAAS,OAAO,OAAO;YACvB,UAAU,OAAO,QAAQ,IAAI;YAC7B,WAAW,OAAO,SAAS;YAC3B,mBAAmB,OAAO,iBAAiB;YAC3C;YACA,YAAY;QACd;IACF,EAAE,OAAO,GAAY;QACnB,MAAM,UAAU,aAAa,QAAQ,EAAE,OAAO,GAAG,OAAO;QACxD,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,IAAI;YAAO,OAAO;QAAQ,GAAG;YAAE,QAAQ;QAAI;IACxE;AACF"}}]
}